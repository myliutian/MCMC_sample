nohup python exp_multi_process.py \
  --graph_dir ./data/P-L-graphs \
  --raw_data_dir ./data/P-L \
  --castp_zip_dir ./data/CASTp \
  --sampling mcmc \
  --split_file Splits/test_pocket.txt \
  --split test > ./results/mcmc.log 2>&1 &

python exp_multi_process.py \
  --graph_dir ./data/P-L-graphs \
  --raw_data_dir ./data/P-L \
  --castp_zip_dir ./data/CASTp \
  --sampling greedy \
  --split_file Splits/test_pocket.txt \
  --split test > ./results/greedy.log 2>&1 &
  
python exp_multi_process.py \
  --graph_dir ./data/P-L-graphs \
  --raw_data_dir ./data/P-L \
  --castp_zip_dir ./data/CASTp \
  --sampling graph_cut \
  --split_file Splits/test_pocket.txt \
  --split test > ./results/graph_cut.log 2>&1 &

python exp_multi_process.py \
  --graph_dir ./data/P-L-graphs \
  --raw_data_dir ./data/P-L \
  --castp_zip_dir ./data/CASTp \
  --sampling spectral \
  --split_file Splits/test_pocket.txt \
  --split test > ./results/spectral.log 2>&1 &

python plot_metric_cdf.py \
  --metric f1 \
  --scheme MCMC=./results/mcmc_test_results.json \
  --scheme greedy=./results/greedy_test_results.json \
  --scheme graph_cut=./results/graph_cut_test_results.json  \
  --scheme spectral=./results/spectral_test_results.json \
  --output ./pic/f1_cdf.png

python plot_metric_cdf.py \
  --metric recall \
  --scheme MCMC=./results/mcmc_test_results.json \
  --scheme greedy=./results/greedy_test_results.json \
  --scheme graph_cut=./results/graph_cut_test_results.json  \
  --scheme spectral=./results/spectral_test_results.json \
  --output ./pic/recall_cdf.png

python plot_metric_cdf.py \
  --metric precision \
  --scheme MCMC=./results/mcmc_test_results.json \
  --scheme greedy=./results/greedy_test_results.json \
  --scheme graph_cut=./results/graph_cut_test_results.json  \
  --scheme spectral=./results/spectral_test_results.json \
  --output ./pic/precision_cdf.png

python plot_metric_cdf.py \
  --metric success_6A \
  --scheme MCMC=./results/mcmc_test_results.json \
  --scheme greedy=./results/greedy_test_results.json \
  --scheme graph_cut=./results/graph_cut_test_results.json  \
  --scheme spectral=./results/spectral_test_results.json \
  --output ./pic/success_6A_cdf.png


\subsection{MCMC近似采样}
\paragraph{}
为了预测蛋白质-配体结合口袋的活性残基，我们采用马尔可夫链蒙特卡洛（MCMC）方法进行近似采样。具体流程如下：

首先，对于每个蛋白质结构，我们基于配体的三维坐标，从残基图中筛选候选口袋残基。候选标准为残基的 $\mathrm{C}_\alpha$ 原子到配体原子中心的距离不超过预设阈值（cutoff）。

然后，我们以这些候选残基的二值状态（活性/非活性）作为马尔可夫链的状态空间，初始化每个残基的活性状态。初始状态可以随机指定一定比例的残基为活性。

在每一步 MCMC 迭代中，我们随机选择一个候选残基，翻转其活性状态，计算新的系统能量。能量函数综合考虑了口袋残基的几何紧凑性（即活性残基间距离分布）和残基间图连通性，具体形式为：
\[
E = \alpha \cdot \text{dist\_term} + \beta \cdot \text{graph\_term},
\]
其中 $\alpha$ 和 $\beta$ 为权重系数，$\text{dist\_term}$ 为活性残基到质心的平均距离，$\text{graph\_term}$ 为活性残基间连边数的负值。

采用 Metropolis-Hastings 接受准则决定是否接受新的状态：
\[
P_{\text{accept}} = 
\begin{cases}
1, & \Delta E < 0\\[2mm]
\exp(-\Delta E / T), & \Delta E \ge 0
\end{cases}
\]
其中 $T$ 为温度参数，控制采样的随机性。

经过预设步数的迭代后，我们舍弃前 $B$ 步作为 burn-in，保留后续的状态序列作为口袋残基的采样结果。为了计算候选残基的出现频率和波动性，我们将每一步采样的活性残基集合记录下来，并进行分段统计，得到每个残基的平均活性概率及时间段内的波动性。

最后，根据残基的出现概率和波动性阈值筛选预测的口袋残基，用于后续的结构中心计算和性能评估。

\subsubsection{候选口袋残基的选择}
在 MCMC 采样之前，我们首先基于配体的三维几何位置对蛋白质残基进行候选筛选，以减少状态空间规模并提高采样效率。与仅使用配体中心距离的粗粒度方法不同，我们采用了一种基于配体原子级最小距离的筛选策略。

具体而言，设配体包含 $N$ 个原子，其三维坐标为
$\{\mathbf{l}_1, \mathbf{l}_2, \dots, \mathbf{l}_N\}$，
蛋白质中第 $i$ 个残基的 $\mathrm{C}_\alpha$ 原子坐标为 $\mathbf{r}_i$。
我们定义该残基到配体的最小距离为：
\[
d_i = \min_{j=1,\dots,N} \|\mathbf{r}_i - \mathbf{l}_j\|_2
\]

当 $d_i \le R_\mathrm{cutoff}$ 时，该残基被纳入候选集合：
\[
\mathcal{C} = \{ r_i \mid d_i \le R_\mathrm{cutoff} \}
\]

其中 $R_\mathrm{cutoff}$ 为预设的空间阈值，在实验中设置为 $12\,\text{\AA}$。

\paragraph{创新点：基于配体尺度自适应的候选残基筛选}

为了解决Cutoff值选择多样性问题，针对不同配体在空间尺度与构型复杂度上的显著差异，我们通过配体几何尺度自适应地调整搜索半径，用于在保证高召回率的同时有效控制候选空间规模。

具体而言，设配体包含 $N$ 个原子，其三维坐标为
$\{\mathbf{l}_1, \mathbf{l}_2, \dots, \mathbf{l}_N\}$。
首先计算配体的几何中心：
\[
\mathbf{c}_\text{lig} = \frac{1}{N} \sum_{i=1}^{N} \mathbf{l}_i
\]
并定义配体的几何半径为其最远原子到几何中心的距离：
\[
r_\text{lig} = \max_{i=1,\dots,N} \|\mathbf{l}_i - \mathbf{c}_\text{lig}\|_2
\]

基于该尺度信息，我们构造自适应搜索半径：
\[
R = \mathrm{clip}(r_\text{lig} + \Delta, R_{\min}, R_{\max})
\]
其中 $\Delta$ 为固定缓冲项，用于覆盖潜在的诱导契合（induced fit）效应，
$R_{\min}$ 与 $R_{\max}$ 分别限制最小与最大搜索范围，防止在极小或极大配体情况下出现退化行为。

我们策略的创新目标与优势在于：

\begin{itemize}
    \item \textbf{配体尺度感知}：搜索半径显式依赖于配体自身的几何尺度，使得小分子与大分子配体在候选筛选阶段具有一致的相对空间覆盖范围。
    
    \item \textbf{缓解固定阈值}：固定 cutoff 在跨数据集或配体尺寸分布变化时往往表现不稳定，而自适应半径显著提升了方法在多样化配体上的鲁棒性。
    
    \item \textbf{为后续统计推断保留充分搜索空间}：通过引入缓冲项 $\Delta$，方法刻意保留较宽的候选区域，将精确筛选的任务交由后续基于图结构的 MCMC 能量函数完成，实现几何先验与统计推断的解耦。
\end{itemize}

\subsubsection{能量函数设计}

在候选残基集合确定后，我们将结合位点预测问题形式化为一个二元状态空间上的能量最小化问题。
设候选残基集合为 $\mathcal{C}$，系统状态定义为
\[
\mathbf{s} = \{s_r \mid r \in \mathcal{C},\ s_r \in \{0,1\}\}
\]
其中 $s_r = 1$ 表示残基 $r$ 被选为口袋残基，$s_r = 0$ 表示未被选中。
对应的激活残基集合为
\[
\mathcal{A}(\mathbf{s}) = \{ r \in \mathcal{C} \mid s_r = 1 \}
\]

我们定义能量函数 $E(\mathbf{s})$ 由几何紧凑性项与图结构连通性项共同组成：
\[
E(\mathbf{s}) = \alpha E_{\text{geo}}(\mathbf{s}) + \beta E_{\text{graph}}(\mathbf{s})
\]
其中 $\alpha$ 与 $\beta$ 为可调权重系数。

\paragraph{几何紧凑性项}
蛋白质结合口袋在空间上通常表现为相对紧凑的残基簇。
为此，我们定义几何紧凑性项为激活残基到其几何中心的平均距离：
\[
E_{\text{geo}}(\mathbf{s}) =
\frac{1}{|\mathcal{A}|}
\sum_{r \in \mathcal{A}}
\left\| \mathbf{x}_r - \bar{\mathbf{x}}_{\mathcal{A}} \right\|_2
\]
其中 $\mathbf{x}_r$ 表示残基 $r$ 的 $C_\alpha$ 坐标，
$\bar{\mathbf{x}}_{\mathcal{A}}$ 为激活残基集合的几何中心。
该项鼓励预测口袋在三维空间中形成紧密、连续的结构。

\paragraph{图连通性项}
为了刻画残基之间的拓扑关系，我们将蛋白质表示为残基图
$G = (V, E)$，其中节点对应残基，边表示空间或相互作用邻接关系。

图连通性项定义为激活残基子图中边的数量：
\[
E_{\text{graph}}(\mathbf{s}) = - \sum_{(i,j) \in E} \mathbb{I}(s_i = 1, s_j = 1)
\]
其中 $\mathbb{I}(\cdot)$ 为指示函数。
该项鼓励预测口袋在残基图中形成高度连通的子图，从而避免空间上离散或不连续的预测结果。

\paragraph{创新点：引入边权重的连通性和相互作用类型能量}
在基础模型中，所有残基间边被视为等价贡献。
然而，不同残基对之间在空间接近程度、结构稳定性或潜在相互作用强度上存在显著差异。

为此，我们进一步将图连通性项推广为带权形式：
\[
E_{\text{graph}}^{\text{weighted}}(\mathbf{s}) =
- \sum_{(i,j) \in E} w_{ij} \cdot \mathbb{I}(s_i = 1, s_j = 1)
\]
其中 $w_{ij}$ 表示残基 $i$ 与 $j$ 之间的边权重，可由残基间距离、接触频率或结构先验信息确定。
该设计使模型能够区分“强结构耦合”与“弱空间邻接”的残基对。
残基之间可能存在不同类型的相互作用，如疏水作用、氢键、盐桥或 $\pi$-$\pi$ 相互作用等。
为刻画这种异质性，我们将边权重分解为不同相互作用类型的组合：
\[
w_{ij} = \sum_{k=1}^{K} \gamma_k \cdot \mathbb{I}\big((i,j) \in E_k\big)
\]
其中 $E_k$ 表示第 $k$ 类相互作用对应的边集合，$\gamma_k$ 为该相互作用类型的权重系数。
最终的图能量项表示为：
\[
E_{\text{graph}}^{\text{int}}(\mathbf{s}) =
- \sum_{k=1}^{K} \gamma_k
\sum_{(i,j) \in E_k}
\mathbb{I}(s_i = 1, s_j = 1)
\]

\subsubsection{状态定义与MCMC采样过程}

在候选残基集确定之后，我们使用马尔可夫链蒙特卡洛（MCMC）方法对潜在口袋进行近似采样，以获得可能的活性残基组合。具体算法步骤如下：

\begin{enumerate}
    \item \textbf{初始化状态}：
    \begin{itemize}
        \item 对每个候选残基 $r \in \mathcal{C}$，以概率 $p$ 将其初始化为活性（$1$）或非活性（$0$）状态：
        \[
        s_r = 
        \begin{cases}
            1, & \text{以概率 } p \\
            0, & \text{以概率 } 1-p
        \end{cases}
        \]
        该策略允许初始状态覆盖较大搜索空间。
    \end{itemize}

    \item \textbf{状态转移（Proposal）}：
    \begin{itemize}
        \item 每一步随机选择一个候选残基 $r$，翻转其当前状态：
        \[
        s_r' = 1 - s_r
        \]
        生成新候选状态 $S'$。
    \end{itemize}

    \item \textbf{能量计算与接受准则}：
    \begin{itemize}
        \item 利用我们定义的 \textit{相互作用感知能量函数} $E(S)$ 计算新状态能量 $E(S')$。
        \item 根据 Metropolis-Hastings 准则决定是否接受：
        \[
        P_{\text{accept}} = 
        \begin{cases}
        1, & \Delta E < 0 \\
        \exp(-\Delta E / T), & \Delta E \ge 0
        \end{cases}, \quad \Delta E = E(S') - E(S)
        \]
        其中 $T$ 为模拟温度。
    \end{itemize}

    \item \textbf{轨迹记录与去掉 Burn-in}：
    \begin{itemize}
        \item 每一步的状态均记录在轨迹列表中，采样结束后可去掉前 $B$ 步作为 Burn-in。
        \item 最终轨迹提供了残基活性概率和波动性的估计。
    \end{itemize}
\end{enumerate}